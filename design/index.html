<!doctype html><html lang=en class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=author content="Jerome Boyer"><link rel=icon href=../assets/images/favicon.png><meta name=generator content="mkdocs-1.3.1, mkdocs-material-8.4.1"><title>Design - Life Insurance Demonstration</title><link rel=stylesheet href=../assets/stylesheets/main.69437709.min.css><link rel=stylesheet href=../assets/stylesheets/palette.cbb835fc.min.css><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback"><style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style><link rel=stylesheet href=../extra.css><script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script></head> <body dir=ltr data-md-color-scheme=default data-md-color-primary data-md-color-accent> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay for=__drawer></label> <div data-md-component=skip> <a href=#solution-design class=md-skip> Skip to content </a> </div> <div data-md-component=announce> </div> <header class="md-header md-header--lifted" data-md-component=header> <nav class="md-header__inner md-grid" aria-label=Header> <a href=.. title="Life Insurance Demonstration" class="md-header__button md-logo" aria-label="Life Insurance Demonstration" data-md-component=logo> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg> </a> <label class="md-header__button md-icon" for=__drawer> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg> </label> <div class=md-header__title data-md-component=header-title> <div class=md-header__ellipsis> <div class=md-header__topic> <span class=md-ellipsis> Life Insurance Demonstration </span> </div> <div class=md-header__topic data-md-component=header-topic> <span class=md-ellipsis> Design </span> </div> </div> </div> <label class="md-header__button md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg> </label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query aria-label=Search placeholder=Search autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=search-query required> <label class="md-search__icon md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg> </label> <nav class=md-search__options aria-label=Search> <button type=reset class="md-search__icon md-icon" aria-label=Clear tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg> </button> </nav> </form> <div class=md-search__output> <div class=md-search__scrollwrap data-md-scrollfix> <div class=md-search-result data-md-component=search-result> <div class=md-search-result__meta> Initializing search </div> <ol class=md-search-result__list></ol> </div> </div> </div> </div> </div> <div class=md-header__source> <a href=https://github.com/jbcodeforce/life-insurance-demo title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 6.1.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg> </div> <div class=md-source__repository> GitHub </div> </a> </div> </nav> <nav class=md-tabs aria-label=Tabs data-md-component=tabs> <div class="md-tabs__inner md-grid"> <ul class=md-tabs__list> <li class=md-tabs__item> <a href=.. class=md-tabs__link> Introduction </a> </li> <li class=md-tabs__item> <a href=../eda/ class=md-tabs__link> Information </a> </li> <li class=md-tabs__item> <a href=./ class="md-tabs__link md-tabs__link--active"> Design </a> </li> <li class=md-tabs__item> <a href=../demo/ class=md-tabs__link> Demonstration </a> </li> <li class=md-tabs__item> <a href=../deployment/ class=md-tabs__link> OpenShift Deployment </a> </li> </ul> </div> </nav> </header> <div class=md-container data-md-component=container> <main class=md-main data-md-component=main> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component=sidebar data-md-type=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary md-nav--lifted" aria-label=Navigation data-md-level=0> <label class=md-nav__title for=__drawer> <a href=.. title="Life Insurance Demonstration" class="md-nav__button md-logo" aria-label="Life Insurance Demonstration" data-md-component=logo> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg> </a> Life Insurance Demonstration </label> <div class=md-nav__source> <a href=https://github.com/jbcodeforce/life-insurance-demo title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 6.1.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg> </div> <div class=md-source__repository> GitHub </div> </a> </div> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=.. class=md-nav__link> Introduction </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" data-md-toggle=__nav_2 type=checkbox id=__nav_2 checked> <label class=md-nav__link for=__nav_2> Information <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Information data-md-level=1> <label class=md-nav__title for=__nav_2> <span class="md-nav__icon md-icon"></span> Information </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../eda/ class=md-nav__link> Why EDA now? </a> </li> <li class=md-nav__item> <a href=https://ibm-cloud-architecture.github.io/refarch-eda/concepts/fit-to-purpose/ class=md-nav__link> Fit for purpose </a> </li> <li class=md-nav__item> <a href=https://ibm-cloud-architecture.github.io/refarch-eda/introduction/reference-architecture/#event-driven-architecture class=md-nav__link> EDA Reference Architecture </a> </li> <li class=md-nav__item> <a href=https://ibm-cloud-architecture.github.io/eda-tech-academy/demo/ class=md-nav__link> Demonstrating Event Streams </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--active"> <input class="md-nav__toggle md-toggle" data-md-toggle=toc type=checkbox id=__toc> <label class="md-nav__link md-nav__link--active" for=__toc> Design <span class="md-nav__icon md-icon"></span> </label> <a href=./ class="md-nav__link md-nav__link--active"> Design </a> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#simple-domain-model-for-client class=md-nav__link> Simple domain model for client </a> </li> <li class=md-nav__item> <a href=#transaction-simulator class=md-nav__link> Transaction Simulator </a> </li> <li class=md-nav__item> <a href=#the-mq-source-connector class=md-nav__link> The MQ source connector </a> </li> <li class=md-nav__item> <a href=#the-client-event-stream-processing class=md-nav__link> The Client event stream processing. </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../demo/ class=md-nav__link> Demonstration </a> </li> <li class=md-nav__item> <a href=../deployment/ class=md-nav__link> OpenShift Deployment </a> </li> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=sidebar data-md-type=toc> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#simple-domain-model-for-client class=md-nav__link> Simple domain model for client </a> </li> <li class=md-nav__item> <a href=#transaction-simulator class=md-nav__link> Transaction Simulator </a> </li> <li class=md-nav__item> <a href=#the-mq-source-connector class=md-nav__link> The MQ source connector </a> </li> <li class=md-nav__item> <a href=#the-client-event-stream-processing class=md-nav__link> The Client event stream processing. </a> </li> </ul> </nav> </div> </div> </div> <div class=md-content data-md-component=content> <article class="md-content__inner md-typeset"> <a href=https://github.com/jbcodeforce/life-insurance-demo/edit/master/docs/design.md title="Edit this page" class="md-content__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25Z"/></svg> </a> <h1 id=solution-design>Solution Design<a class=headerlink href=#solution-design title="Permanent link">&para;</a></h1> <h2 id=simple-domain-model-for-client>Simple domain model for client<a class=headerlink href=#simple-domain-model-for-client title="Permanent link">&para;</a></h2> <p>We can use a simple client model to define a life insurance client that can have different benifeciary or transfer the life insurance to other persons. The model can be see as:</p> <p><img alt src=../images/lf-model.png></p> <p>Life insurance policy can be transferred to a family member or someone else, therefore the model stores not only information about the client to whom the policy belongs but also information about any related people and their relationship to the client.</p> <p>Client information is in <code>Person</code> objecr, but also as a <code>Client</code>. Other people related to the client to whom the policy may be transferred or who may receive the policy benefit upon the clientâ€™s death are also <code>Person</code>s.</p> <p>Client Category is to be able to classify client for marketing reason based on demographics and financial details.</p> <p>The remaining two classes are needed for describing the nature of the relationship between clients and other people. Relation types is stored in the <code>ClientRelationType</code>. </p> <p>The <code>ClientRelated</code> instances store references to the client (client_id), the related person (person_id), the nature of that relation (client_relation_type_id), all addition details (details), if any, and a flag indicating whether the relation is currently active (is_active).</p> <p>The java classes for this model are in the <code>lf-tx-simulator</code> project.</p> <p>In the future, can extend this model with the Life Insurance offer and product.</p> <p>Model inspiration is coming from <a href=https://vertabelo.com/blog/life-insurance-data-model/ >Vertabelo blog</a></p> <h2 id=transaction-simulator>Transaction Simulator<a class=headerlink href=#transaction-simulator title="Permanent link">&para;</a></h2> <p>The code is under the folder <a href=https://github.com/jbcodeforce/life-insurance-demo/tree/main/lf-tx-simulator>lf-tx-simulator</a> and use JMS API to interact with MQ.</p> <p><img alt src=../images/tx-simulator.png> </p> <p>The main class is in <a href=https://github.com/jbcodeforce/life-insurance-demo/blob/main/lf-tx-simulator/src/main/java/org/acme/infra/messages/MQProducer.java>MQProducer.java</a> and expose a send(client) method with the domain class and prepare a transaction event message. The following code extract illustrates this:</p> <div class=highlight><pre><span></span><code><a id=__codelineno-0-1 name=__codelineno-0-1 href=#__codelineno-0-1></a><span class=w>      </span><span class=c1>// this is more a demo trick. Should think of a better implementation</span><span class=w></span>
<a id=__codelineno-0-2 name=__codelineno-0-2 href=#__codelineno-0-2></a><span class=w>      </span><span class=n>TransactionEvent</span><span class=w> </span><span class=n>tx</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>TransactionEvent</span><span class=p>();</span><span class=w></span>
<a id=__codelineno-0-3 name=__codelineno-0-3 href=#__codelineno-0-3></a><span class=w>      </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>newClient</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w></span>
<a id=__codelineno-0-4 name=__codelineno-0-4 href=#__codelineno-0-4></a><span class=w>        </span><span class=n>tx</span><span class=p>.</span><span class=na>type</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>TransactionEvent</span><span class=p>.</span><span class=na>TX_CLIENT_CREATED</span><span class=p>;</span><span class=w></span>
<a id=__codelineno-0-5 name=__codelineno-0-5 href=#__codelineno-0-5></a><span class=w>      </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w></span>
<a id=__codelineno-0-6 name=__codelineno-0-6 href=#__codelineno-0-6></a><span class=w>        </span><span class=n>tx</span><span class=p>.</span><span class=na>type</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>TransactionEvent</span><span class=p>.</span><span class=na>TX_CLIENT_UPDATED</span><span class=p>;</span><span class=w></span>
<a id=__codelineno-0-7 name=__codelineno-0-7 href=#__codelineno-0-7></a><span class=w>      </span><span class=p>}</span><span class=w></span>
<a id=__codelineno-0-8 name=__codelineno-0-8 href=#__codelineno-0-8></a>
<a id=__codelineno-0-9 name=__codelineno-0-9 href=#__codelineno-0-9></a><span class=w>      </span><span class=n>tx</span><span class=p>.</span><span class=na>payload</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>client</span><span class=p>;</span><span class=w> </span>
<a id=__codelineno-0-10 name=__codelineno-0-10 href=#__codelineno-0-10></a><span class=w>      </span><span class=n>tx</span><span class=p>.</span><span class=na>txid</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>client</span><span class=p>.</span><span class=na>id</span><span class=p>;</span><span class=w></span>
<a id=__codelineno-0-11 name=__codelineno-0-11 href=#__codelineno-0-11></a><span class=w>      </span><span class=n>tx</span><span class=p>.</span><span class=na>timestamp</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Date</span><span class=p>().</span><span class=na>getTime</span><span class=p>();</span><span class=w></span>
<a id=__codelineno-0-12 name=__codelineno-0-12 href=#__codelineno-0-12></a><span class=w>      </span><span class=n>String</span><span class=w> </span><span class=n>msg</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>parser</span><span class=p>.</span><span class=na>writeValueAsString</span><span class=p>(</span><span class=n>tx</span><span class=p>);</span><span class=w></span>
<a id=__codelineno-0-13 name=__codelineno-0-13 href=#__codelineno-0-13></a><span class=w>      </span><span class=n>TextMessage</span><span class=w> </span><span class=n>message</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>jmsContext</span><span class=p>.</span><span class=na>createTextMessage</span><span class=p>(</span><span class=n>msg</span><span class=p>);</span><span class=w></span>
<a id=__codelineno-0-14 name=__codelineno-0-14 href=#__codelineno-0-14></a><span class=w>      </span><span class=n>message</span><span class=p>.</span><span class=na>setJMSCorrelationID</span><span class=p>(</span><span class=n>client</span><span class=p>.</span><span class=na>id</span><span class=p>);</span><span class=w></span>
<a id=__codelineno-0-15 name=__codelineno-0-15 href=#__codelineno-0-15></a><span class=w>      </span><span class=n>producer</span><span class=p>.</span><span class=na>send</span><span class=p>(</span><span class=n>destination</span><span class=p>,</span><span class=w> </span><span class=n>message</span><span class=p>);</span><span class=w></span>
</code></pre></div> <p>The transaction event adds meta data and supports generic payload. We may replace it with <a href=https://cloudevents.github.io/sdk-java/core.html>CloudEvent</a>.</p> <p>The code is using the JMSCorrelationID to define the potential Key to be used by Kafka producer. We will detail that in next section.</p> <p>The rest of this application exposes a REST resource to control the simulation and sends some new client data or update to existing client's one. The APIs should be enough to demonstrate the needed requirements.</p> <p><img alt src=../images/simul-apis.png></p> <p>The deployment descriptors are in the <a href=https://github.com/jbcodeforce/life-insurance-demo/tree/main/environments/lf-demo/apps/lf-tx-simulator>environements/apps folder</a></p> <h2 id=the-mq-source-connector>The MQ source connector<a class=headerlink href=#the-mq-source-connector title="Permanent link">&para;</a></h2> <p>The declaration of the Kafka connect cluster is done in the <a href=https://github.com/jbcodeforce/life-insurance-demo/tree/main/environments/lf-demo/services/kconnect>environements/service folder</a> and the MQ source connector in <a href=https://github.com/jbcodeforce/life-insurance-demo/blob/main/environments/lf-demo/apps/mq-source/kafka-mq-src-connector.yaml>kafka-mq-src-connector.yaml</a>.</p> <p>The interesting part of the connector configuration is the use of JMS and the JMSCorrelationID as a source for the Kafka Record key.</p> <div class=highlight><pre><span></span><code><a id=__codelineno-1-1 name=__codelineno-1-1 href=#__codelineno-1-1></a><span class=w>    </span><span class=nt>mq.record.builder</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">com.ibm.eventstreams.connect.mqsource.builders.DefaultRecordBuilder</span><span class=w></span>
<a id=__codelineno-1-2 name=__codelineno-1-2 href=#__codelineno-1-2></a><span class=w>    </span><span class=nt>mq.connection.mode</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">client</span><span class=w></span>
<a id=__codelineno-1-3 name=__codelineno-1-3 href=#__codelineno-1-3></a><span class=w>    </span><span class=nt>mq.message.body.jms</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">true</span><span class=w></span>
<a id=__codelineno-1-4 name=__codelineno-1-4 href=#__codelineno-1-4></a><span class=w>    </span><span class=nt>mq.record.builder.key.header</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">JMSCorrelationID</span><span class=w></span>
</code></pre></div> <h2 id=the-client-event-stream-processing>The Client event stream processing.<a class=headerlink href=#the-client-event-stream-processing title="Permanent link">&para;</a></h2> <p>The code is in the <a href=https://github.com/jbcodeforce/life-insurance-demo/tree/main/client-event-processing>client-event-processing folder</a>, and supports the implementation of the green component in figure below:</p> <p><img alt src=../images/stream-processing.png></p> <p>The streaming algorithm is quite simple:</p> <ol> <li> <p>get continuous update of the category reference data: this should be rare, but the process will get any new updated to those data. This will be a Table in memory and persisted in Kafka to keep only the last update per record key. The table below illustrates the mockup data used:</p> <table> <thead> <tr> <th>Key</th> <th>Value</th> </tr> </thead> <tbody> <tr> <td>1</td> <td>"category_name": "Personal"</td> </tr> <tr> <td>2</td> <td>"category_name": "VIP"</td> </tr> <tr> <td>3</td> <td>"category_name": "Employee"</td> </tr> <tr> <td>4</td> <td>"category_name": "Business"</td> </tr> </tbody> </table> <p>Topology code with GlobalKtable so if we partition the input stream we have a unique table.</p> <div class=highlight><pre><span></span><code><a id=__codelineno-2-1 name=__codelineno-2-1 href=#__codelineno-2-1></a><span class=n>GlobalKTable</span><span class=o>&lt;</span><span class=n>Integer</span><span class=p>,</span><span class=w> </span><span class=n>ClientCategory</span><span class=o>&gt;</span><span class=w> </span><span class=n>categories</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>builder</span><span class=p>.</span><span class=na>globalTable</span><span class=p>(</span><span class=n>categoriesInputStreamName</span><span class=p>,</span><span class=w></span>
<a id=__codelineno-2-2 name=__codelineno-2-2 href=#__codelineno-2-2></a><span class=w>                                                    </span><span class=n>Consumed</span><span class=p>.</span><span class=na>with</span><span class=p>(</span><span class=n>Serdes</span><span class=p>.</span><span class=na>Integer</span><span class=p>(),</span><span class=w>  </span>
<a id=__codelineno-2-3 name=__codelineno-2-3 href=#__codelineno-2-3></a><span class=w>                                                    </span><span class=n>categorySerder</span><span class=p>),</span><span class=w>  </span><span class=n>Materialized</span><span class=p>.</span><span class=na>as</span><span class=p>(</span><span class=n>storeSupplier</span><span class=p>));</span><span class=w></span>
</code></pre></div> </li> <li> <p>Process transaction events in a streams, validate the data, and any transaction in error goes to dead letter queue.</p> <div class=highlight><pre><span></span><code><a id=__codelineno-3-1 name=__codelineno-3-1 href=#__codelineno-3-1></a><span class=p>{</span><span class=w></span>
<a id=__codelineno-3-2 name=__codelineno-3-2 href=#__codelineno-3-2></a><span class=w>  </span><span class=nt>&quot;id&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;101012&quot;</span><span class=p>,</span><span class=w></span>
<a id=__codelineno-3-3 name=__codelineno-3-3 href=#__codelineno-3-3></a><span class=w>  </span><span class=nt>&quot;code&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;C02&quot;</span><span class=p>,</span><span class=w></span>
<a id=__codelineno-3-4 name=__codelineno-3-4 href=#__codelineno-3-4></a><span class=w>  </span><span class=nt>&quot;insuredPerson&quot;</span><span class=p>:</span><span class=w> </span><span class=p>{</span><span class=w></span>
<a id=__codelineno-3-5 name=__codelineno-3-5 href=#__codelineno-3-5></a><span class=w>      </span><span class=nt>&quot;id&quot;</span><span class=p>:</span><span class=w> </span><span class=mi>2</span><span class=p>,</span><span class=w></span>
<a id=__codelineno-3-6 name=__codelineno-3-6 href=#__codelineno-3-6></a><span class=w>      </span><span class=nt>&quot;code&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;P02&quot;</span><span class=p>,</span><span class=w></span>
<a id=__codelineno-3-7 name=__codelineno-3-7 href=#__codelineno-3-7></a><span class=w>      </span><span class=nt>&quot;first_name&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;julie&quot;</span><span class=p>,</span><span class=w></span>
<a id=__codelineno-3-8 name=__codelineno-3-8 href=#__codelineno-3-8></a><span class=w>      </span><span class=nt>&quot;last_name&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;thesimmer&quot;</span><span class=p>,</span><span class=w></span>
<a id=__codelineno-3-9 name=__codelineno-3-9 href=#__codelineno-3-9></a><span class=w>      </span><span class=nt>&quot;address&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;10 market street, CA, San Franciso&quot;</span><span class=p>,</span><span class=w></span>
<a id=__codelineno-3-10 name=__codelineno-3-10 href=#__codelineno-3-10></a><span class=w>      </span><span class=nt>&quot;phone&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;650-650-650&quot;</span><span class=p>,</span><span class=w></span>
<a id=__codelineno-3-11 name=__codelineno-3-11 href=#__codelineno-3-11></a><span class=w>      </span><span class=nt>&quot;mobile&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;&quot;</span><span class=p>,</span><span class=w></span>
<a id=__codelineno-3-12 name=__codelineno-3-12 href=#__codelineno-3-12></a><span class=w>      </span><span class=nt>&quot;email&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;jswimmer@email.com&quot;</span><span class=w></span>
<a id=__codelineno-3-13 name=__codelineno-3-13 href=#__codelineno-3-13></a><span class=w>  </span><span class=p>},</span><span class=w> </span>
<a id=__codelineno-3-14 name=__codelineno-3-14 href=#__codelineno-3-14></a><span class=w>  </span><span class=nt>&quot;client_category_id&quot;</span><span class=p>:</span><span class=w> </span><span class=mi>1</span><span class=w></span>
<a id=__codelineno-3-15 name=__codelineno-3-15 href=#__codelineno-3-15></a><span class=p>}</span><span class=w></span>
</code></pre></div> <p>The transaction streaming processing start with the following statements:</p> <div class=highlight><pre><span></span><code><a id=__codelineno-4-1 name=__codelineno-4-1 href=#__codelineno-4-1></a><span class=n>KStream</span><span class=o>&lt;</span><span class=n>String</span><span class=p>,</span><span class=w> </span><span class=n>TransactionEvent</span><span class=o>&gt;</span><span class=w> </span><span class=n>transactions</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>builder</span><span class=p>.</span><span class=na>stream</span><span class=p>(</span><span class=n>transactionsInputStreamName</span><span class=p>,</span><span class=w></span>
<a id=__codelineno-4-2 name=__codelineno-4-2 href=#__codelineno-4-2></a><span class=w>                                                    </span><span class=n>Consumed</span><span class=p>.</span><span class=na>with</span><span class=p>(</span><span class=n>Serdes</span><span class=p>.</span><span class=na>String</span><span class=p>(),</span><span class=w>  </span>
<a id=__codelineno-4-3 name=__codelineno-4-3 href=#__codelineno-4-3></a><span class=w>                                                                 </span><span class=n>transactionEventSerder</span><span class=p>));</span><span class=w></span>
<a id=__codelineno-4-4 name=__codelineno-4-4 href=#__codelineno-4-4></a><span class=n>Map</span><span class=o>&lt;</span><span class=n>String</span><span class=p>,</span><span class=w> </span><span class=n>KStream</span><span class=o>&lt;</span><span class=n>String</span><span class=p>,</span><span class=w> </span><span class=n>TransactionEvent</span><span class=o>&gt;&gt;</span><span class=w> </span><span class=n>branches</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>transactions</span><span class=w></span>
<a id=__codelineno-4-5 name=__codelineno-4-5 href=#__codelineno-4-5></a><span class=w>    </span><span class=p>.</span><span class=na>split</span><span class=p>(</span><span class=n>Named</span><span class=p>.</span><span class=na>as</span><span class=p>(</span><span class=s>&quot;A-&quot;</span><span class=p>))</span><span class=w></span>
<a id=__codelineno-4-6 name=__codelineno-4-6 href=#__codelineno-4-6></a><span class=w>    </span><span class=p>.</span><span class=na>branch</span><span class=p>((</span><span class=n>k</span><span class=p>,</span><span class=n>v</span><span class=p>)</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=n>transactionNotValid</span><span class=p>(</span><span class=n>v</span><span class=p>),</span><span class=w> </span><span class=n>Branched</span><span class=p>.</span><span class=na>as</span><span class=p>(</span><span class=s>&quot;error&quot;</span><span class=p>))</span><span class=w></span>
<a id=__codelineno-4-7 name=__codelineno-4-7 href=#__codelineno-4-7></a><span class=w>    </span><span class=p>.</span><span class=na>defaultBranch</span><span class=p>(</span><span class=n>Branched</span><span class=p>.</span><span class=na>as</span><span class=p>(</span><span class=s>&quot;good-data&quot;</span><span class=p>));</span><span class=w></span>
</code></pre></div> <p>This is an exactly once delivery.</p> </li> <li> <p>Transform the input transaction hierarchical model into a flat model: <a href=https://github.com/jbcodeforce/life-insurance-demo/blob/main/client-event-processing/src/main/java/org/acme/infra/events/ClientOutput.java>ClientOutput class</a></p> <div class=highlight><pre><span></span><code><a id=__codelineno-5-1 name=__codelineno-5-1 href=#__codelineno-5-1></a><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>ClientOutput</span><span class=w> </span><span class=kd>implements</span><span class=w> </span><span class=n>JSONSerdeCompatible</span><span class=w> </span><span class=p>{</span><span class=w></span>
<a id=__codelineno-5-2 name=__codelineno-5-2 href=#__codelineno-5-2></a><span class=kd>public</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>client_id</span><span class=p>;</span><span class=w></span>
<a id=__codelineno-5-3 name=__codelineno-5-3 href=#__codelineno-5-3></a><span class=kd>public</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>client_code</span><span class=p>;</span><span class=w></span>
<a id=__codelineno-5-4 name=__codelineno-5-4 href=#__codelineno-5-4></a><span class=kd>public</span><span class=w> </span><span class=n>Integer</span><span class=w> </span><span class=n>client_category_id</span><span class=p>;</span><span class=w></span>
<a id=__codelineno-5-5 name=__codelineno-5-5 href=#__codelineno-5-5></a><span class=kd>public</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>client_category_name</span><span class=p>;</span><span class=w></span>
<a id=__codelineno-5-6 name=__codelineno-5-6 href=#__codelineno-5-6></a><span class=kd>public</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>first_name</span><span class=p>;</span><span class=w></span>
<a id=__codelineno-5-7 name=__codelineno-5-7 href=#__codelineno-5-7></a><span class=kd>public</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>last_name</span><span class=p>;</span><span class=w></span>
<a id=__codelineno-5-8 name=__codelineno-5-8 href=#__codelineno-5-8></a><span class=kd>public</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>address</span><span class=p>;</span><span class=w></span>
<a id=__codelineno-5-9 name=__codelineno-5-9 href=#__codelineno-5-9></a><span class=kd>public</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>phone</span><span class=p>;</span><span class=w></span>
<a id=__codelineno-5-10 name=__codelineno-5-10 href=#__codelineno-5-10></a><span class=kd>public</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>mobile</span><span class=p>;</span><span class=w></span>
<a id=__codelineno-5-11 name=__codelineno-5-11 href=#__codelineno-5-11></a><span class=kd>public</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>email</span><span class=p>;</span><span class=w></span>
</code></pre></div> <p>Data transformation is simple:</p> <div class=highlight><pre><span></span><code><a id=__codelineno-6-1 name=__codelineno-6-1 href=#__codelineno-6-1></a><span class=n>branches</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=s>&quot;A-good-data&quot;</span><span class=p>)</span><span class=w></span>
<a id=__codelineno-6-2 name=__codelineno-6-2 href=#__codelineno-6-2></a><span class=w>    </span><span class=p>.</span><span class=na>mapValues</span><span class=p>(</span><span class=n>v</span><span class=w> </span><span class=o>-&gt;</span><span class=w>  </span><span class=n>buildClientOutputFromTransaction</span><span class=p>(</span><span class=n>v</span><span class=p>))</span><span class=w></span>
</code></pre></div> </li> <li> <p>Enrich with the category name by doing a join with the categories table</p> <div class=highlight><pre><span></span><code><a id=__codelineno-7-1 name=__codelineno-7-1 href=#__codelineno-7-1></a><span class=w> </span><span class=p>.</span><span class=na>join</span><span class=p>(</span><span class=n>categories</span><span class=p>,</span><span class=w></span>
<a id=__codelineno-7-2 name=__codelineno-7-2 href=#__codelineno-7-2></a><span class=w>        </span><span class=p>(</span><span class=n>txid</span><span class=p>,</span><span class=n>co</span><span class=p>)</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=n>co</span><span class=p>.</span><span class=na>client_category_id</span><span class=p>,</span><span class=w></span>
<a id=__codelineno-7-3 name=__codelineno-7-3 href=#__codelineno-7-3></a><span class=w>        </span><span class=c1>//When you join a stream and a table, you get a new stream</span><span class=w></span>
<a id=__codelineno-7-4 name=__codelineno-7-4 href=#__codelineno-7-4></a><span class=w>        </span><span class=p>(</span><span class=n>oldOutput</span><span class=p>,</span><span class=n>matchingCategory</span><span class=p>)</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ClientOutput</span><span class=p>(</span><span class=n>oldOutput</span><span class=p>,</span><span class=n>matchingCategory</span><span class=p>.</span><span class=na>category_name</span><span class=p>)</span><span class=w></span>
<a id=__codelineno-7-5 name=__codelineno-7-5 href=#__codelineno-7-5></a><span class=w>    </span><span class=p>)</span><span class=w>  </span>
</code></pre></div> </li> <li> <p>Route based on category name content to different target.</p> <div class=highlight><pre><span></span><code><a id=__codelineno-8-1 name=__codelineno-8-1 href=#__codelineno-8-1></a><span class=w> </span><span class=p>.</span><span class=na>branch</span><span class=p>(</span><span class=w> </span><span class=p>(</span><span class=n>k</span><span class=p>,</span><span class=n>v</span><span class=p>)</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=n>v</span><span class=p>.</span><span class=na>client_category_name</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>v</span><span class=p>.</span><span class=na>client_category_name</span><span class=p>.</span><span class=na>equals</span><span class=p>(</span><span class=s>&quot;Business&quot;</span><span class=p>),</span><span class=w> </span><span class=n>Branched</span><span class=p>.</span><span class=na>as</span><span class=p>(</span><span class=s>&quot;category-b&quot;</span><span class=p>))</span><span class=w></span>
<a id=__codelineno-8-2 name=__codelineno-8-2 href=#__codelineno-8-2></a><span class=w>    </span><span class=p>.</span><span class=na>defaultBranch</span><span class=p>(</span><span class=n>Branched</span><span class=p>.</span><span class=na>as</span><span class=p>(</span><span class=s>&quot;category-a&quot;</span><span class=p>));</span><span class=w></span>
</code></pre></div> </li> </ol> <p>The deployment descriptors are in the <a href=https://github.com/jbcodeforce/life-insurance-demo/tree/main/environments/lf-demo/apps/client-event-processing>environments/apps/client-event-processing folder</a> </p> <p><a href=../demo/ >&gt;&gt;&gt; Next: demonstration script</a></p> </article> </div> </div> </main> <footer class=md-footer> <nav class="md-footer__inner md-grid" aria-label=Footer> <a href=../eda/ class="md-footer__link md-footer__link--prev" aria-label="Previous: Why EDA now?" rel=prev> <div class="md-footer__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg> </div> <div class=md-footer__title> <div class=md-ellipsis> <span class=md-footer__direction> Previous </span> Why EDA now? </div> </div> </a> <a href=../demo/ class="md-footer__link md-footer__link--next" aria-label="Next: Demonstration" rel=next> <div class=md-footer__title> <div class=md-ellipsis> <span class=md-footer__direction> Next </span> Demonstration </div> </div> <div class="md-footer__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"/></svg> </div> </a> </nav> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-copyright> Made with <a href=https://squidfunk.github.io/mkdocs-material/ target=_blank rel=noopener> Material for MkDocs </a> </div> </div> </div> </footer> </div> <div class=md-dialog data-md-component=dialog> <div class="md-dialog__inner md-typeset"></div> </div> <script id=__config type=application/json>{"base": "..", "features": ["content.code.annotate", "content.tooltips", "navigation.tabs", "navigation.instant", "navigation.sections", "navigation.expand", "navigation.tabs.sticky"], "search": "../assets/javascripts/workers/search.ecf98df9.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version.title": "Select version"}}</script> <script src=../assets/javascripts/bundle.9c69f0bc.min.js></script> </body> </html>